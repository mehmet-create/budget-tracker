{% extends 'tracker/base.html' %}
{% load tracker_filters %}

{% block title %}Financial Visuals{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="text-center mb-5">
        <h2 class="fw-bold">Financial Analysis</h2>
        <p class="text-muted">Visualizing your income, expenses, and spending habits.</p>
        
        <div class="d-inline-block px-4 py-2 rounded-pill shadow-sm {% if balance >= 0 %}bg-success bg-opacity-10 text-success border border-success{% else %}bg-danger bg-opacity-10 text-danger border border-danger{% endif %}">
            <span class="fw-bold me-2">Net Balance:</span>
            <span class="fs-5 fw-bold">{% currency balance %}</span>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-chart-bar me-2"></i>Income vs Expense</h5>
                </div>
                <div class="card-body">
                    <div style="position: relative; height: 350px;">
                        <canvas id="financeChart" role="img" aria-label="Income, expense, and net balance bar chart"></canvas>
                    </div>
                    <div id="financeSummary" class="visually-hidden"></div>
                    <table class="table table-sm mt-3" aria-label="Income and expense data">
                        <tbody>
                            <tr>
                                <th scope="row">Income</th>
                                <td class="text-end" id="incomeCell"></td>
                            </tr>
                            <tr>
                                <th scope="row">Expense</th>
                                <td class="text-end" id="expenseCell"></td>
                            </tr>
                            <tr>
                                <th scope="row">Net Balance</th>
                                <td class="text-end" id="balanceCell"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-warning"><i class="fas fa-chart-pie me-2"></i>Spending Breakdown</h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    {% if category_values %}
                        <div style="position: relative; height: 350px; width: 100%;">
                            <canvas id="expensePie" role="img" aria-label="Expense breakdown doughnut chart"></canvas>
                        </div>
                        <div id="expenseSummary" class="visually-hidden"></div>
                        <table class="table table-sm mt-3" aria-label="Expense breakdown by category">
                            <thead>
                                <tr>
                                    <th scope="col">Category</th>
                                    <th scope="col" class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody"></tbody>
                        </table>
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-search-dollar fa-3x mb-3 opacity-25"></i>
                            <p>No expense data found to display.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
    // --- Data from Django ---
    const income = {{ total_income|default:0 }};
    const expense = {{ total_expense|default:0 }};
    const balance = {{ balance|default:0 }};
    const currencySymbol = "{{ CUSTOM_CURRENCY_SYMBOL }}";

    // --- 1. BAR CHART CONFIG ---
    const barCtx = document.getElementById('financeChart').getContext('2d');
    const balanceColor = balance >= 0 ? '#198754' : '#dc3545'; // Bootstrap Success/Danger colors

    const formatCurrency = (value) => `${currencySymbol}${Number(value).toLocaleString()}`;

    const financeSummary = document.getElementById('financeSummary');
    const incomeCell = document.getElementById('incomeCell');
    const expenseCell = document.getElementById('expenseCell');
    const balanceCell = document.getElementById('balanceCell');

    if (financeSummary && incomeCell && expenseCell && balanceCell) {
        incomeCell.textContent = formatCurrency(income);
        expenseCell.textContent = formatCurrency(expense);
        balanceCell.textContent = formatCurrency(balance);
        financeSummary.textContent = `Income ${formatCurrency(income)}, Expense ${formatCurrency(expense)}, Net Balance ${formatCurrency(balance)}.`;
    }

    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: ['Income', 'Expense', 'Net Balance'],
            datasets: [{
                label: 'Amount',
                data: [income, expense, balance],
                backgroundColor: [
                    '#198754', // Green for Income
                    '#dc3545', // Red for Expense
                    balanceColor
                ],
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return currencySymbol + context.raw.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: '#f0f0f0' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // --- 2. PIE CHART CONFIG ---
    {% if category_values %}
    const pieCtx = document.getElementById('expensePie').getContext('2d');
    
    // Calculate total for percentage
    const pieData = {{ category_values|safe }};
    const totalExpense = pieData.reduce((a, b) => a + b, 0);
    const expenseSummary = document.getElementById('expenseSummary');
    const expenseTableBody = document.getElementById('expenseTableBody');

    if (expenseSummary && expenseTableBody) {
        const labels = {{ category_labels|safe }};
        expenseTableBody.innerHTML = labels.map((label, index) => {
            const value = pieData[index] ?? 0;
            return `<tr><th scope="row">${label}</th><td class="text-end">${formatCurrency(value)}</td></tr>`;
        }).join('');
        expenseSummary.textContent = labels.map((label, index) => `${label}: ${formatCurrency(pieData[index] ?? 0)}`).join(', ');
    }

    new Chart(pieCtx, {
        type: 'doughnut', // Doughnut looks more modern than Pie
        data: {
            labels: {{ category_labels|safe }},
            datasets: [{
                data: pieData,
                backgroundColor: [
                    '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', 
                    '#e74a3b', '#858796', '#5a5c69', '#fd7e14'
                ],
                borderWidth: 2,
                borderColor: '#fff',
                hoverOffset: 4
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: 20
            },
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                datalabels: {
                    color: '#fff',
                    font: {
                        weight: 'bold',
                        size: 11
                    },
                    formatter: (value) => {
                        let percentage = (value * 100 / totalExpense).toFixed(1) + "%";
                        // Only show label if slice is big enough (>5%)
                        return (value * 100 / totalExpense) > 5 ? percentage : null;
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) { label += ': '; }
                            label += currencySymbol + context.raw.toLocaleString();
                            return label;
                        }
                    }
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}