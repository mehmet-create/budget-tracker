{% extends 'tracker/base.html' %}
{% load tracker_filters %}

{% block title %}Charts â€” BudgetApp{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
{% endblock %}

{% block content %}
<div class="text-center mb-4">
    <h2 class="fw-bold">Financial Analysis</h2>
    <p class="text-muted small">Your income, expenses, and spending habits at a glance.</p>
    <span class="badge {% if balance >= 0 %}bg-success{% else %}bg-danger{% endif %} fs-6 px-3 py-2">
        Net Balance: {% currency balance %}
    </span>
</div>

<div class="row g-4">
    <!-- Bar Chart -->
    <div class="col-12 col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold small"><i class="fas fa-chart-bar me-2 text-primary"></i>Income vs Expense</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="financeChart"></canvas>
                </div>
                <table class="table table-sm mt-3 small">
                    <tbody>
                        <tr><th>Income</th><td class="text-end text-success fw-bold" id="incomeCell"></td></tr>
                        <tr><th>Expense</th><td class="text-end text-danger fw-bold" id="expenseCell"></td></tr>
                        <tr><th>Net Balance</th><td class="text-end fw-bold" id="balanceCell"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pie Chart -->
    <div class="col-12 col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold small"><i class="fas fa-chart-pie me-2 text-warning"></i>Spending Breakdown</h5>
            </div>
            <div class="card-body">
                {% if category_values %}
                    <div class="chart-container">
                        <canvas id="expensePie"></canvas>
                    </div>
                    <table class="table table-sm mt-3 small">
                        <thead><tr><th>Category</th><th class="text-end">Amount</th></tr></thead>
                        <tbody id="expenseTableBody"></tbody>
                    </table>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-search-dollar fa-3x d-block"></i>
                        <p class="small">No expense data yet.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{{ category_labels|json_script:"cat-labels" }}
{{ category_values|json_script:"cat-values" }}
{% endblock %}

{% block scripts %}
<script>
const sym = "{{ CUSTOM_CURRENCY_SYMBOL|escapejs }}";
const fmt = v => `${sym}${Number(v).toLocaleString(undefined,{minimumFractionDigits:2})}`;
const income  = {{ total_income|default:0 }};
const expense = {{ total_expense|default:0 }};
const balance = {{ balance|default:0 }};

document.getElementById('incomeCell').textContent  = fmt(income);
document.getElementById('expenseCell').textContent = fmt(expense);
const bc = document.getElementById('balanceCell');
bc.textContent = fmt(balance);
bc.className = 'text-end fw-bold ' + (balance >= 0 ? 'text-success' : 'text-danger');

new Chart(document.getElementById('financeChart'), {
    type: 'bar',
    data: {
        labels: ['Income', 'Expense', 'Net Balance'],
        datasets: [{ data: [income, expense, balance],
            backgroundColor: ['#198754','#dc3545', balance >= 0 ? '#198754' : '#dc3545'],
            borderRadius: 6, borderWidth: 0 }]
    },
    options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => fmt(c.raw) } } },
        scales: { y: { beginAtZero: true, grid: { color: '#f0f0f0' } }, x: { grid: { display: false } } }
    }
});

{% if category_values %}
const pieLabels = JSON.parse(document.getElementById('cat-labels').textContent);
const pieData   = JSON.parse(document.getElementById('cat-values').textContent);
const total = pieData.reduce((a,b) => a+b, 0);

document.getElementById('expenseTableBody').innerHTML =
    pieLabels.map((l,i) => `<tr><th>${l}</th><td class="text-end">${fmt(pieData[i])}</td></tr>`).join('');

new Chart(document.getElementById('expensePie'), {
    type: 'doughnut',
    data: {
        labels: pieLabels,
        datasets: [{ data: pieData,
            backgroundColor: ['#4e73df','#1cc88a','#36b9cc','#f6c23e','#e74a3b','#858796','#5a5c69','#fd7e14'],
            borderWidth: 2, borderColor: '#fff', hoverOffset: 4 }]
    },
    plugins: [ChartDataLabels],
    options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom', labels: { usePointStyle: true, padding: 14, font: { size: 11 } } },
            datalabels: { color: '#fff', font: { weight: 'bold', size: 11 },
                formatter: v => (v*100/total) > 5 ? (v*100/total).toFixed(1)+'%' : null },
            tooltip: { callbacks: { label: c => `${c.label}: ${fmt(c.raw)}` } }
        }
    }
});
{% endif %}
</script>
{% endblock %}